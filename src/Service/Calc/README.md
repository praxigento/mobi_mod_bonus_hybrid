Этот каталог нужно отрефакторить, он "сшит на белую нитку" - нужно разнести все расчеты по отдельным сервисам. Иначе эта беда сложно тестируется.